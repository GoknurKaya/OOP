@model OOP.Models.GameViewModel
@{
    ViewData["Title"] = "Oyun Ekranı";
}

<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        margin: 0;
        padding: 20px 0;
    }

    .game-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Başlık Bölümü */
    .game-header {
        text-align: center;
        margin-bottom: 30px;
        animation: fadeInDown 0.6s ease-out;
    }

    .game-title {
        font-size: 3rem;
        font-weight: bold;
        color: white;
        text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        margin-bottom: 10px;
        letter-spacing: 2px;
    }

    /* Skor Paneli */
    .score-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        animation: fadeInDown 0.8s ease-out;
    }

    .score-container {
        display: flex;
        justify-content: space-around;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .score-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px 30px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 15px;
        min-width: 150px;
        transition: transform 0.3s;
    }

        .score-item:hover {
            transform: translateY(-5px);
        }

    .score-label {
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .score-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #333;
    }

    .player-score-item {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    }

    .ai-score-item {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .shot-count-item {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }

    /* Mesaj Kutusu */
    .message-box {
        text-align: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        margin-top: 15px;
        backdrop-filter: blur(10px);
    }

    #message {
        font-size: 1.3rem;
        font-weight: bold;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        min-height: 30px;
    }

    /* Tahta Konteyneri */
    .boards-container {
        display: flex;
        justify-content: center;
        gap: 40px;
        flex-wrap: wrap;
        animation: fadeIn 1s ease-out;
    }

    .board-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 15px 50px rgba(0,0,0,0.4);
        transition: transform 0.3s;
    }

        .board-section:hover {
            transform: translateY(-5px);
        }

    .board-title {
        text-align: center;
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .player-board-section .board-title {
        color: #4caf50;
    }

    .ai-board-section .board-title {
        color: #f44336;
    }

    /* Grid Tasarımı */
    .grid-container {
        display: grid;
        grid-template-columns: repeat(10, 45px);
        grid-template-rows: repeat(10, 45px);
        gap: 3px;
        border: 4px solid #333;
        border-radius: 10px;
        padding: 5px;
        background: linear-gradient(135deg, #434343 0%, #000000 100%);
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
    }

    .grid-cell {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 2px solid #90caf9;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }

        .grid-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .grid-cell:hover::before {
            opacity: 1;
        }

        .grid-cell:hover {
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

    .grid-cell-player {
        cursor: default;
    }

        .grid-cell-player:hover {
            transform: scale(1.05);
        }

    /* Durum Stilleri */
    .status-0 {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    }

    .status-1 {
        background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
        color: white;
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        animation: pulse 2s infinite;
    }

    .status-2 {
        background: linear-gradient(135deg, #f44336 0%, #e57373 100%);
        color: white;
        box-shadow: 0 0 20px rgba(244, 67, 54, 0.8);
        animation: explosion 0.5s ease-out;
    }

    .status-3 {
        background: linear-gradient(135deg, #03a9f4 0%, #4fc3f7 100%);
        color: white;
        box-shadow: 0 0 10px rgba(3, 169, 244, 0.5);
    }

    .disabled-board {
        pointer-events: none;
        opacity: 0.6;
    }

    /* Buton Stili */
    .action-buttons {
        text-align: center;
        margin-top: 40px;
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        animation: fadeInUp 1s ease-out;
    }

    .btn-game {
        padding: 15px 35px;
        font-size: 1.2rem;
        font-weight: bold;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

        .btn-game:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

    .btn-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-new-game {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

</style>

<div class="game-wrapper">
    <div class="game-header">
        <h1 class="game-title">⚓ AMIRAL BATTI ⚓</h1>
    </div>

    <div class="score-panel">
        <div class="score-container">
            <div class="score-item shot-count-item">
                <div class="score-label">💣 Toplam Atış</div>
                <div class="score-value" id="shot-count">0</div>
            </div>

            <div class="score-item player-score-item">
                <div class="score-label">👤 Sizin İsabetleriniz</div>
                <div class="score-value"><span id="player-hits">0</span>/9</div>
            </div>

            <div class="score-item ai-score-item">
                <div class="score-label">🤖 AI'ın İsabetleri</div>
                <div class="score-value"><span id="ai-hits">0</span>/9</div>
            </div>
        </div>

        <div class="message-box">
            <p id="message">Rakip tahtasına ateş edin!</p>
        </div>
    </div>

    <div class="boards-container">
        <div class="board-section player-board-section">
            <h3 class="board-title">🛡️ Sizin Filonuz</h3>
            <div class="grid-container" id="player-board">
                @for (int y = 0; y < 10; y++)
                {
                    for (int x = 0; x < 10; x++)
                    {
                        var cellValue = Model.PlayerBoardData[x][y];
                        var statusClass = $"status-{cellValue}";
                        <div class="grid-cell grid-cell-player @statusClass" data-x="@x" data-y="@y">
                            @if (cellValue == 1)
                            {
                                @:🚢
                            }
                            else if (cellValue == 2)
                            {
                                @:💥
                            }
                            else if (cellValue == 3)
                            {
                                @:💨
                            }
                        </div>
                    }
                }
            </div>
        </div>

        <div class="board-section ai-board-section">
            <h3 class="board-title">🎯 Düşman Filوsu</h3>
            <div class="grid-container" id="ai-board">
                @for (int y = 0; y < 10; y++)
                {
                    for (int x = 0; x < 10; x++)
                    {
                        var status = Model.AIBoardData[x][y];
                        var statusClass = $"status-{(status == 1 ? 0 : status)}";
                        <div class="grid-cell ai-cell @statusClass" data-x="@x" data-y="@y">
                            @if (status == 2)
                            {
                                @:💥
                            }
                            else if (status == 3)
                            {
                                @:💨
                            }
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <a asp-action="Statistics" class="btn-game btn-stats">📊 İstatistiklerim</a>
        <a asp-action="ShipPlacement" class="btn-game btn-new-game">🔄 Yeni Oyun</a>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var shotCount = 0;
    var isProcessing = false;
    var gameOver = false;
    var playerHits = 0;
    var aiHits = 0;

    $(document).ready(function () {
        $('.ai-cell').on('click', function () {
            if (gameOver) return;

            if (isProcessing) {
                $('#message').text('⏳ Lütfen bekleyin...');
                return;
            }

            var cell = $(this);
            if (cell.hasClass('status-2') || cell.hasClass('status-3')) {
                $('#message').text('⚠️ Buraya daha önce ateş ettiniz!');
                return;
            }

            var x = cell.data('x');
            var y = cell.data('y');

            isProcessing = true;
            $('#ai-board').addClass('disabled-board');

            shotCount++;
            $('#shot-count').text(shotCount);

            $.ajax({
                url: '@Url.Action("Fire", "Home")',
                type: 'POST',
                data: { x: x, y: y },
                success: function (response) {
                    if (!response.success) {
                        $('#message').text(response.message || 'Bir hata oluştu.');
                        isProcessing = false;
                        $('#ai-board').removeClass('disabled-board');
                        return;
                    }

                    if (response.playerHits !== undefined) {
                        playerHits = response.playerHits;
                        $('#player-hits').text(playerHits);
                    }
                    if (response.aiHits !== undefined) {
                        aiHits = response.aiHits;
                        $('#ai-hits').text(aiHits);
                    }

                    if (response.playerHit === true) {
                        cell.removeClass().addClass('grid-cell ai-cell status-2').html('💥');
                        $('#message').text('🎯 İSABET! Harika atış! (' + playerHits + '/9)');
                    } else {
                        cell.removeClass().addClass('grid-cell ai-cell status-3').html('💨');
                        $('#message').text('💨 Iskaladınız!');
                    }

                    if (response.gameover && response.winner === "Player") {
                        gameOver = true;
                        setTimeout(function() {
                            $.ajax({
                                url: '@Url.Action("EndGame", "Home")',
                                type: 'POST',
                                data: { isWin: true, shotsTaken: shotCount },
                                success: function() {
                                    $('#message').html('🎉🏆 TEBRİKLER! KAZANDINIZ! 🏆🎉<br>Toplam Atış: ' + shotCount);
                                    setTimeout(function() {
                                        window.location.href = '@Url.Action("Statistics", "Home")';
                                    }, 2000);
                                }
                            });
                        }, 500);
                        return;
                    }

                    setTimeout(function() {
                        if (response.aiShot) {
                            var aiShotCell = $('#player-board .grid-cell[data-x="' + response.aiShot.x + '"][data-y="' + response.aiShot.y + '"]');

                            if (response.aiShot.hit) {
                                aiShotCell.removeClass().addClass('grid-cell grid-cell-player status-2').html('💥');
                                $('#message').text($('#message').text() + ' | 🤖 AI isabet etti! (' + aiHits + '/9)');
                            } else {
                                aiShotCell.removeClass().addClass('grid-cell grid-cell-player status-3').html('💨');
                                $('#message').text($('#message').text() + ' | 🤖 AI ıskaladı.');
                            }

                            if (response.gameover && response.winner === "AI") {
                                gameOver = true;
                                setTimeout(function() {
                                    $.ajax({
                                        url: '@Url.Action("EndGame", "Home")',
                                        type: 'POST',
                                        data: { isWin: false, shotsTaken: 0 },
                                        success: function() {
                                            $('#message').html('😞 Kaybettiniz! AI filonuzu batırdı!');
                                            setTimeout(function() {
                                                window.location.href = '@Url.Action("Statistics", "Home")';
                                            }, 2000);
                                        }
                                    });
                                }, 500);
                                return;
                            }
                        }

                        isProcessing = false;
                        $('#ai-board').removeClass('disabled-board');
                    }, 1000);
                },
                error: function () {
                    $('#message').text('❌ Sunucu hatası.');
                    isProcessing = false;
                    $('#ai-board').removeClass('disabled-board');
                }
            });
        });
    });
</script>