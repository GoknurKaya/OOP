@model OOP.Models.GameViewModel
@{
    ViewData["Title"] = "Oyun Ekranı";
}

<style>
    .grid-container {
        display: grid;
        grid-template-columns: repeat(10, 30px);
        grid-template-rows: repeat(10, 30px);
        gap: 1px;
        border: 2px solid #333;
    }

    .grid-cell {
        background-color: #eee;
        border: 1px solid #ccc;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
    }

    .grid-cell-player {
        cursor: default;
    }

    .status-0 {
        background-color: #eee;
    }

    .status-1 {
        background-color: #555;
        color: white;
    }

    .status-2 {
        background-color: #d9534f;
    }

    .status-3 {
        background-color: #5bc0de;
    }

    .disabled-board {
        pointer-events: none;
        opacity: 0.6;
    }
</style>

<h2>💣 Battleship - Savaş Alanı</h2>
<hr>

<div class="row">
    <div class="col-6">
        <h3>Sizin Tahtanız</h3>
        <div class="grid-container" id="player-board">
            @for (int y = 0; y < 10; y++)
            {
                for (int x = 0; x < 10; x++)
                {
                    var cellValue = Model.PlayerBoardData[x][y];
                    var statusClass = $"status-{cellValue}";
                    <div class="grid-cell grid-cell-player @statusClass" data-x="@x" data-y="@y">
                        @(cellValue == 1 ? "🚢" : "")
                    </div>
                }
            }
        </div>
    </div>

    <div class="col-6">
        <h3>Rakip Tahtası (Atış Alanınız)</h3>
        <div class="grid-container" id="ai-board">
            @for (int y = 0; y < 10; y++)
            {
                for (int x = 0; x < 10; x++)
                {
                    var status = Model.AIBoardData[x][y];
                    var statusClass = $"status-{(status == 1 ? 0 : status)}";
                    <div class="grid-cell ai-cell @statusClass" data-x="@x" data-y="@y"></div>
                }
            }
        </div>
        <p id="message" class="mt-3"></p>
        <p>Atış Sayısı: <span id="shot-count">0</span></p>
    </div>
</div>

<a asp-action="Statistics" class="btn btn-info mt-3">📊 İstatistiklerime Bak</a>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var shotCount = 0;
    var isProcessing = false;

    $(document).ready(function () {
        $('.ai-cell').on('click', function () {
            if (isProcessing) {
                $('#message').text('⏳ Lütfen bekleyin...');
                return;
            }

            var cell = $(this);
            if (cell.hasClass('status-2') || cell.hasClass('status-3')) {
                $('#message').text('⚠️ Buraya daha önce ateş ettiniz!');
                return;
            }

            var x = cell.data('x');
            var y = cell.data('y');

            isProcessing = true;
            $('#ai-board').addClass('disabled-board');

            shotCount++;
            $('#shot-count').text(shotCount);

            $.ajax({
                url: '@Url.Action("Fire", "Home")',
                type: 'POST',
                data: { x: x, y: y },
                success: function (response) {
                    if (!response.success) {
                        $('#message').text(response.message || 'Bir hata oluştu.');
                        isProcessing = false;
                        $('#ai-board').removeClass('disabled-board');
                        return;
                    }

                    if (response.playerHit) {
                        cell.removeClass('status-0').addClass('status-2').text('💥');
                        $('#message').text('🎯 İsabet! Düşman gemisini vurdunuz.');
                    } else {
                        cell.removeClass('status-0').addClass('status-3').text('○');
                        $('#message').text('💨 Iska! Vuramadınız.');
                    }

                    if (response.gameover && response.winner === "Player") {
                        setTimeout(function() {
                            alert("🎉 Tebrikler! Tüm düşman gemilerini batırdınız. Kazandınız!");
                            window.location.href = '@Url.Action("Statistics", "Home")';
                        }, 500);
                        return;
                    }

                    setTimeout(function() {
                        var aiShotCell = $('#player-board .grid-cell[data-x="' + response.aiShot.x + '"][data-y="' + response.aiShot.y + '"]');

                        if (response.aiShot.hit) {
                            aiShotCell.removeClass('status-1').addClass('status-2').text('💥');
                            $('#message').append(' | 🤖 Düşman isabet etti!');
                        } else {
                            aiShotCell.removeClass('status-0 status-1').addClass('status-3').text('○');
                            $('#message').append(' | 🤖 Düşman ıskaladı.');
                        }

                        if (response.gameover && response.winner === "AI") {
                            setTimeout(function() {
                                alert("😞 Kaybettiniz! Düşman tüm gemilerinizi batırdı.");
                                window.location.href = '@Url.Action("Statistics", "Home")';
                            }, 500);
                            return;
                        }

                        isProcessing = false;
                        $('#ai-board').removeClass('disabled-board');
                    }, 800);
                },
                error: function () {
                    $('#message').text('❌ Sunucu hatası.');
                    isProcessing = false;
                    $('#ai-board').removeClass('disabled-board');
                }
            });
        });
    });
</script>